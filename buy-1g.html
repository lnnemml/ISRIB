<!DOCTYPE html>
<html lang="en">
<head>
  <script src="/scripts/gtm.js" async></script>
  
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Adding ISRIB A15 1g to cart...</title>
  <link rel="icon" type="image/png" href="/images/favicon-32x32.png">
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .loader {
      text-align: center;
      padding: 40px;
      background: rgba(255,255,255,0.1);
      border-radius: 20px;
      backdrop-filter: blur(10px);
    }
    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    h1 {
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0 0 10px;
    }
    p {
      opacity: 0.9;
      margin: 0;
    }
  </style>
</head>
<body>
  <div class="loader">
    <div class="spinner"></div>
    <h1>Adding ISRIB A15 (1g) to your cart...</h1>
    <p>Redirecting to secure checkout</p>
  </div>

  <script>
    // ============================================
    // ‚úÖ –í–ò–ü–†–ê–í–õ–ï–ù–ò–ô –ö–û–î
    // ============================================
    (function() {
      console.log('[BUY-1G] üöÄ Initializing direct purchase...');
      
      // ============================================
      // 1. –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø DATALAYER (–ö–†–ò–¢–ò–ß–ù–û!)
      // ============================================
      window.dataLayer = window.dataLayer || [];
      
      // ============================================
      // 2. –ì–ï–ù–ï–†–ê–¶–Ü–Ø TRANSACTION ID
      // ============================================
      function getOrCreateTransactionId() {
        const SESSION_KEY = '_txn_id';
        const TIMESTAMP_KEY = '_txn_timestamp';
        const MAX_AGE = 30 * 60 * 1000; // 30 —Ö–≤–∏–ª–∏–Ω
        
        try {
          const stored = sessionStorage.getItem(SESSION_KEY);
          const timestamp = parseInt(sessionStorage.getItem(TIMESTAMP_KEY) || '0');
          
          if (stored && (Date.now() - timestamp) < MAX_AGE) {
            console.log('[TXN] ‚ôªÔ∏è Reusing existing ID:', stored);
            return stored;
          }
        } catch(e) {
          console.warn('[TXN] ‚ö†Ô∏è SessionStorage error:', e);
        }
        
        const timestamp = Date.now();
        const random = Math.random().toString(36).substring(2, 9);
        const txnId = `TXN-${timestamp}-${random}`.toUpperCase();
        
        try {
          sessionStorage.setItem(SESSION_KEY, txnId);
          sessionStorage.setItem(TIMESTAMP_KEY, timestamp.toString());
          console.log('[TXN] ‚ú® Created new ID:', txnId);
        } catch(e) {
          console.warn('[TXN] ‚ö†Ô∏è Cannot save to sessionStorage');
        }
        
        return txnId;
      }
      
      const TRANSACTION_ID = getOrCreateTransactionId();
      
      // ============================================
      // 3. –ó–ë–ï–†–ï–ñ–ï–ù–ù–Ø –î–ê–ù–ò–• –î–õ–Ø CHECKOUT
      // ============================================
      try {
        sessionStorage.setItem('_checkout_data', JSON.stringify({
          transaction_id: TRANSACTION_ID,
          product: 'ISRIB A15 1g',
          quantity: '1g',
          price: 200,
          timestamp: Date.now(),
          purchase_type: 'direct_buy'
        }));
        console.log('[BUY-1G] üíæ Checkout data saved');
      } catch(e) {
        console.error('[BUY-1G] ‚ùå Cannot save checkout data:', e);
      }
      
      // ============================================
      // 4. CART FUNCTIONS
      // ============================================
      function normalizeCartUnits(arr) {
        return (arr || []).map((i) => {
          let grams = Number(i.grams || 0);
          if (i.display) {
            const mgFromLabel = parseQtyToMg(i.display);
            if (mgFromLabel) grams = mgFromLabel;
          }
          return { 
            ...i, 
            grams,
            count: Number(i.count || 1),
            price: Number(i.price || 0)
          };
        });
      }

      function parseQtyToMg(s) {
        if (!s) return 0;
        const t = String(s).toLowerCase().trim();
        const n = parseFloat(t.replace(/[^0-9.]/g, '')) || 0;
        return t.includes('g') && !t.includes('mg') ? Math.round(n * 1000) : Math.round(n);
      }

      function readCart() {
        try { 
          const raw = JSON.parse(localStorage.getItem('isrib_cart') || '[]') || [];
          return normalizeCartUnits(raw);
        } catch { 
          return []; 
        }
      }

      function writeCart(arr) {
        localStorage.setItem('isrib_cart', JSON.stringify(arr || []));
      }

      function addToCart(name, sku, grams, price, display) {
        const cart = readCart();
        const gramsInMg = Number(grams) || 0;
        
        const idx = cart.findIndex(i => 
          i.sku === sku && 
          Number(i.grams) === gramsInMg && 
          Number(i.price) === Number(price)
        );
        
        if (idx >= 0) {
          cart[idx].count = Number(cart[idx].count || 1) + 1;
        } else {
          cart.push({ 
            name, 
            sku, 
            grams: gramsInMg,
            price: Number(price) || 0, 
            display: display || null, 
            count: 1, 
            unit: 'pack' 
          });
        }
        
        writeCart(cart);
      }

      // ============================================
      // 5. –î–û–î–ê–Ñ–ú–û –î–û –ö–û–®–ò–ö–ê
      // ============================================
      addToCart('ISRIB A15', 'isrib-a15', 1000, 200, '1g');
      console.log('[BUY-1G] ‚úÖ Added to cart');

      // ============================================
      // 6. GA4 EVENT: ADD_TO_CART_DIRECT (HIGH INTENT)
      // ============================================
      
      // ‚úÖ –í–ê–ñ–õ–ò–í–û: –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ setTimeout —â–æ–± GTM –≤—Å—Ç–∏–≥ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏—Å—å
      setTimeout(function() {
        try {
          console.log('[GA4] üì§ Preparing add_to_cart_direct event...');
          
          window.dataLayer.push({
            event: 'add_to_cart_direct',
            ecommerce: {
              currency: 'USD',
              value: 200,
              items: [{
                item_id: 'isrib-a15',
                item_name: 'ISRIB A15',
                item_variant: '1g',
                item_category: 'Research Compounds',
                price: 200,
                quantity: 1
              }]
            },
            transaction_id: TRANSACTION_ID,
            purchase_intent: 'high',
            event_category: 'ecommerce',
            event_label: 'Direct Buy: ISRIB A15 1g'
          });
          
          console.log('[GA4] ‚úÖ add_to_cart_direct sent:', {
            product: 'ISRIB A15 1g',
            value: 200,
            transaction_id: TRANSACTION_ID,
            intent: 'high'
          });
          
          // ‚úÖ –î–æ–¥–∞—î–º–æ fallback –¥–ª—è debug
          console.log('[GA4] dataLayer state:', window.dataLayer);
          
        } catch(e) {
          console.error('[GA4] ‚ùå add_to_cart_direct failed:', e);
        }
      }, 300); // ‚úÖ –ó–∞—Ç—Ä–∏–º–∫–∞ 300ms –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è GTM

      // ============================================
      // 7. –†–ï–î–Ü–†–ï–ö–¢ –ù–ê CHECKOUT
      // ============================================
      setTimeout(function() {
        console.log('[BUY-1G] üîÑ Redirecting to checkout...');
        window.location.href = '/checkout.html';
      }, 1000); // ‚úÖ –ó–±—ñ–ª—å—à–µ–Ω–æ –¥–æ 1000ms —â–æ–± GA4 –≤—Å—Ç–∏–≥ –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏

    })();
  </script>
</body>
</html>
