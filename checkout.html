<!doctype html>
<html lang="en">
<head>

  <script src="/scripts/gtm.js" async></script>
  <script src="/scripts/ga4-fallback.js" defer></script>
  <!-- Reddit Pixel -->
  <script src="/scripts/reddit-pixel.js"></script>

  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Checkout ‚Äî ISRIB.shop</title>
  <meta name="description" content="Complete your order request. Research use only. Worldwide shipping.">
  <!-- Favicon & App Icons -->
<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
<link rel="manifest" href="/images/site.webmanifest">
<link rel="shortcut icon" href="/images/favicon.ico">
<meta name="theme-color" content="#ffffff">

  <!-- Unified CSS -->
  <link rel="stylesheet" href="css/styles.css?v=11" />

  <!-- Page‚Äëscoped cosmetics (–º—ñ–Ω—ñ–º—É–º) -->
  <style>
    .checkout-hero{
      background: linear-gradient(135deg,#f8fafc 0%,#e2e8f0 100%);
      padding: 60px 0 50px; text-align:center; position:relative;
    }
    .checkout-hero::before{
      content:''; position:absolute; inset:0;
      background:
        radial-gradient(circle at 18% 82%, rgba(30,64,175,.10) 0%, transparent 50%),
        radial-gradient(circle at 84% 18%, rgba(14,165,233,.10) 0%, transparent 50%);
    }
    .checkout-hero .title{ position:relative; z-index:1; font-weight:900; font-size:clamp(2.2rem,4.5vw,3.4rem); color:#1e293b; margin:0 0 10px; }
    .checkout-hero .sub{ position:relative; z-index:1; color:#64748b; font-size:1.1rem; max-width:680px; margin:0 auto; }

    /* ============================================ */
    /* Payment Method Selection - Redesigned       */
    /* ============================================ */
    .payment-option {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 16px;
      padding: 20px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.25s ease;
      background: #fff;
      position: relative;
    }

    .payment-option:hover {
      border-color: #cbd5e1;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      transform: translateY(-2px);
    }

    .payment-option:has(input:checked) {
      border-color: #3b82f6;
      background: linear-gradient(135deg, #eff6ff 0%, #f8fafc 100%);
      box-shadow: 0 8px 24px rgba(59, 130, 246, 0.15);
    }

    /* Custom Radio Button */
    .payment-radio {
      position: relative;
      width: 24px;
      height: 24px;
      flex-shrink: 0;
      margin-top: 2px;
    }

    .payment-radio input[type="radio"] {
      position: absolute;
      opacity: 0;
      width: 24px;
      height: 24px;
      cursor: pointer;
    }

    .radio-mark {
      position: absolute;
      top: 0;
      left: 0;
      width: 24px;
      height: 24px;
      border: 2px solid #cbd5e1;
      border-radius: 50%;
      background: #fff;
      transition: all 0.2s ease;
    }

    .radio-mark::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #3b82f6;
      transition: transform 0.2s ease;
    }

    .payment-radio input:checked ~ .radio-mark {
      border-color: #3b82f6;
      background: #eff6ff;
    }

    .payment-radio input:checked ~ .radio-mark::after {
      transform: translate(-50%, -50%) scale(1);
    }

    /* Payment Content */
    .payment-content {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .payment-title {
      font-size: 16px;
      font-weight: 700;
      color: #1e293b;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .payment-methods {
      font-size: 12px;
      font-weight: 500;
      color: #64748b;
      background: #f1f5f9;
      padding: 4px 10px;
      border-radius: 6px;
      white-space: nowrap;
    }

    .discount-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: #fff;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
    }

    .payment-description {
      font-size: 14px;
      color: #64748b;
      line-height: 1.5;
    }

    .payment-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      width: fit-content;
      margin-top: 4px;
    }

    .payment-badge.warning {
      background: #fef3c7;
      color: #92400e;
      border: 1px solid #fde68a;
    }

    .payment-badge.success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #a7f3d0;
    }

    .bitcoin-savings {
      display: none;
      margin-top: 12px;
      padding: 12px 16px;
      background: linear-gradient(135deg, #dcfdf7 0%, #d1fae5 100%);
      border-left: 4px solid #10b981;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 700;
      color: #065f46;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Mobile responsive */
    @media (max-width: 640px) {
      .payment-option {
        grid-template-columns: 1fr;
        gap: 12px;
        padding: 16px;
      }

      .payment-radio {
        position: absolute;
        top: 16px;
        right: 16px;
      }

      .payment-content {
        padding-left: 0;
      }

      .payment-title {
        font-size: 15px;
      }

      .payment-methods {
        font-size: 11px;
      }
    }
  </style>
</head>
<body>

  <!-- Header (slim + sticky + burger) -->
<header class="header-slim site-header" id="siteHeader">
  <div class="container">
    <div class="header-content">
      <a href="/" class="logo-slim" aria-label="ISRIB.shop home">
        <img src="images/logo-dark-trimmed.png" alt="ISRIB.shop Logo" class="logo-image-slim"/>
      </a>

      <!-- Desktop nav -->
      <nav class="nav-slim" aria-label="Primary">
        <a href="products.html">Products</a>
        <a href="about.html">About</a>
        <a href="faq.html">FAQ</a>
        <a href="contact.html">Contact</a>
        <a href="checkout.html" class="cart-btn-slim" id="cartBtn">
          üß∫ <span>Cart</span> <span id="cartCount" class="badge-slim">0</span>
        </a>
      </nav>

      <!-- Mobile actions group (cart + burger) -->
      <div class="mobile-actions">
        <!-- Mobile cart button (always visible) -->
        <a href="checkout.html" class="cart-btn-mobile" id="cartBtnMobile" aria-label="View cart">
          üß∫ <span id="cartCountMobileBtn" class="badge-mobile">0</span>
        </a>

       <!-- Burger (mobile) -->
  <button class="burger" id="burgerBtn"
          aria-label="Open menu" aria-expanded="false" aria-controls="mobileMenu">
    <svg class="burger-icon" width="22" height="22" viewBox="0 0 24 24"
         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" aria-hidden="true">
      <path d="M4 7h16M4 12h16M10 17h10"/>
    </svg>
  </button>
      </div>

  <!-- Mobile menu -->
  <nav class="mobile-menu" id="mobileMenu" data-nav aria-label="Mobile">
    <a href="products.html" class="mm-link">Products</a>
    <a href="about.html" class="mm-link">About</a>
    <a href="faq.html" class="mm-link">FAQ</a>
    <a href="contact.html" class="mm-link">Contact</a>
  </nav>
</div>
</header>

  <!-- Page Header -->
  <section class="checkout-hero">
    <div class="container">
      <h1 class="title">Checkout</h1>
      <p class="sub">Fill the form below. We'll confirm availability, shipping and payment details via email or messenger.</p>
      
      <div class="free-shipping-banner">
        <span class="emoji">üöö</span>
        <strong>Free Worldwide Shipping</strong>
        <span>on all orders ‚Äî limited-time launch offer</span>
      </div>
      
      <!-- Progress bar -->
      <div style="max-width:800px;margin:0 auto 32px;padding:0 20px;">
        <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
          <span style="color:#10b981;font-weight:600;">‚úì Cart</span>
          <span style="color:#3b82f6;font-weight:600;">‚Üí Shipping</span>
          <span style="color:#94a3b8;">‚úì Complete</span>
        </div>
        <div style="height:4px;background:#e5e7eb;border-radius:2px;">
          <div style="width:66%;height:100%;background:#3b82f6;border-radius:2px;"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Checkout Content -->
  <main class="checkout-wrap">
    <div class="container">
      <div class="checkout-grid">
        <!-- LEFT: Form -->
        <form id="checkoutForm" class="card checkout-form" novalidate>
          <div class="card-body">
            <h2>Shipping & Contact</h2>

            <div class="form-two">
              <div class="form-group">
                <label for="firstName">First name<span class="req">*</span></label>
                <input id="firstName" name="firstName" autocomplete="given-name" required />
              </div>
              <div class="form-group">
                <label for="lastName">Last name<span class="req">*</span></label>
                <input id="lastName" name="lastName" autocomplete="family-name" required />
              </div>
            </div>

            <div class="form-group">
              <label for="email">Email<span class="req">*</span></label>
              <input id="email" name="email" type="email" autocomplete="email" required />
            </div>

            <div class="form-two">
              <div class="form-group">
                <label for="country">Country<span class="req">*</span></label>
                <input id="country" name="country" autocomplete="country-name" required />
              </div>
              <div class="form-group">
                <label for="region">Region/State</label>
                <input id="region" name="region" autocomplete="address-level1" />
              </div>
            </div>

            <div class="form-two">
              <div class="form-group">
                <label for="city">City<span class="req">*</span></label>
                <input id="city" name="city" autocomplete="address-level2" required />
              </div>
              <div class="form-group">
                <label for="postal">Postal code<span class="req">*</span></label>
                <input id="postal" name="postal" autocomplete="postal-code" required />
              </div>
            </div>

            <div class="form-two">
              <div class="form-group full">
                <label for="address">Address<span class="req">*</span></label>
                <input id="address" name="address" autocomplete="address-line1" required />
              </div>
            </div>

            <div class="form-two">
              <div class="form-group">
                <label for="messenger">Preferred messenger (optional)</label>
                <select id="messenger" name="messenger">
                  <option value="">Select‚Ä¶</option>
                  <option>Telegram</option>
                  <option>Signal</option>
                  <option>WhatsApp</option>
                </select>
              </div>
              <div class="form-group">
                <label for="handle">Handle / phone (optional)</label>
                <input id="handle" name="handle" placeholder="@username or +1‚Ä¶" />
              </div>
            </div>

            <div class="form-group">
              <label for="notes">Notes (optional)</label>
              <textarea id="notes" name="notes" rows="3" placeholder="Institute / lab, delivery preferences, etc."></textarea>
            </div>

            <!-- honeypot -->
            <input type="text" name="_gotcha" class="hidden" aria-hidden="true" tabindex="-1" autocomplete="off"/>

            <label class="agree-row">
              <input type="checkbox" id="researchOnly" required />
              <span class="muted">
                I confirm the products are ordered strictly for <strong>research use only</strong>. Not for human consumption, clinical, or veterinary use.
                I agree to the <a class="link" href="terms.html">Terms</a>, <a class="link" href="privacy.html">Privacy Policy</a>, and <a class="link" href="disclaimer.html">Disclaimer</a>.
              </span>
            </label>

            <!-- Payment Method Selection -->
            <div class="payment-method-section" style="margin-top:32px;margin-bottom:24px;">
              <h3 style="font-size:17px;font-weight:700;margin-bottom:20px;color:#1e293b;text-align:center;">Choose Payment Method</h3>

              <div class="payment-options" style="display:grid;gap:16px;">
                <!-- Manual Payment Option (Default) -->
                <label class="payment-option" data-payment="manual">
                  <div class="payment-radio">
                    <input type="radio" name="paymentMethod" value="manual" id="paymentManual" checked />
                    <span class="radio-mark"></span>
                  </div>
                  <div class="payment-content">
                    <div class="payment-title">
                      Manual Payment
                      <span class="payment-methods">SWIFT ‚Ä¢ SEPA ‚Ä¢ PayPal ‚Ä¢ Crypto</span>
                    </div>
                    <div class="payment-description">
                      We'll arrange payment details individually via email
                    </div>
                    <div class="payment-badge warning">
                      <span>‚è±</span>
                      <span>Requires manual confirmation (1-3 business days)</span>
                    </div>
                  </div>
                </label>

                <!-- Bitcoin Payment Option (with discount) -->
                <label class="payment-option" data-payment="bitcoin">
                  <div class="payment-radio">
                    <input type="radio" name="paymentMethod" value="bitcoin" id="paymentBitcoin" />
                    <span class="radio-mark"></span>
                  </div>
                  <div class="payment-content">
                    <div class="payment-title">
                      Bitcoin Payment
                      <span class="discount-badge">Save 10%</span>
                    </div>
                    <div class="payment-description">
                      Pay with Bitcoin via BTCPay Server ‚Äî instant confirmation
                    </div>
                    <div class="payment-badge success">
                      <span>‚ö°</span>
                      <span>Automatic confirmation ‚Äî No waiting!</span>
                    </div>
                    <div id="bitcoinSavings" class="bitcoin-savings">
                      <!-- –î–∏–Ω–∞–º—ñ—á–Ω–æ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î—Ç—å—Å—è savings -->
                    </div>
                  </div>
                </label>
              </div>
            </div>

            <div class="form-actions">
              <button id="submitOrderBtn" class="btn btn-primary" type="submit">
                Submit Order Request
              </button>
              <div id="formMsg" class="form-status muted" role="status" aria-live="polite"></div>
            </div>
          </div>
        </form>

        <!-- RIGHT: Summary -->
        <aside class="card order-card">
          <div class="card-body">
            <h2>Order Summary</h2>

            <!-- —Å–ø–∏—Å–æ–∫ –ø–æ–∑–∏—Ü—ñ–π -->
            <div id="cartList" class="cart-list"></div>
            
            <!-- Promo code -->
            <div class="promo-section" style="margin:20px 0;">
              <div class="form-group">
                <label for="promoCode">Promo code (optional)</label>
                <div style="display:flex;gap:8px;">
                  <input 
                    type="text" 
                    id="promoCode" 
                    name="promoCode" 
                    placeholder="Enter code" 
                    style="flex:1;text-transform:uppercase;padding-left:14px;padding-right:14px;"
                    autocomplete="off"
                  />
                  <button 
                    type="button" 
                    id="applyPromoBtn" 
                    class="btn btn-outline"
                    style="white-space:nowrap;"
                  >
                    Apply
                  </button>
                </div>
                <div id="promoMsg" style="margin-top:8px;font-size:13px;"></div>
              </div>
            </div>
            
            <!-- –ø—ñ–¥—Å—É–º–∫–∏ -->
            <div id="summaryTotals" class="totals" aria-live="polite"></div>

            <hr class="sep" />

            <!-- Upsell Widget (–¥–∏–Ω–∞–º—ñ—á–Ω–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç) -->
            <div class="card upsell-widget" id="checkoutUpsell">
              <div class="card-body">
                <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –≥–µ–Ω–µ—Ä—É—î—Ç—å—Å—è —á–µ—Ä–µ–∑ initCheckoutUpsell() -->
              </div>
            </div>
            
            <div class="pill">Research Use Only</div>
            <ul class="muted ro-list">
              <li>COA available per batch</li>
              <li>Worldwide shipping</li>
              <li>Secure packaging</li>
              <li>Support via Email/Telegram/Signal</li>
              <li>Payments arranged individually</li>
            </ul>
          </div>
        </aside>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <div class="footer-content">
        <div class="footer-section">
          <h3>ISRIB Shop</h3>
          <p>Advanced research chemicals for scientific advancement. Trusted by researchers worldwide for quality and reliability.</p>
          <p><strong>Email:</strong> isrib.shop@protonmail.com</p>
        </div>
        <div class="footer-section">
          <h3>Products</h3>
          <ul>
            <li><a href="product_isrib_A15.html">ISRIB-A15</a></li>
            <li><a href="product_isrib.html">ISRIB Original</a></li>
            <li><a href="product_zzl_7.html">ZZL-7</a></li>
            <li><a href="product_MPEP.html">MPEP Oxalate</a></li>
            <li><a href="products.html">All Products</a></li>
          </ul>
        </div>
        <div class="footer-section">
          <h3>Information</h3>
          <ul>
            <li><a href="about.html">About Us</a></li>
            <li><a href="faq.html">FAQ</a></li>
            <li><a href="contact.html">Contact</a></li>
            <li><a href="quality.html">Quality Control</a></li>
            <li><a href="safety.html">Safety Guidelines</a></li>
          </ul>
        </div>
        <div class="footer-section">
          <h3>Legal</h3>
          <ul>
            <li><a href="terms.html">Terms of Service</a></li>
            <li><a href="privacy.html">Privacy Policy</a></li>
            <li><a href="research.html">Research Use Only</a></li>
            <li><a href="disclaimer.html">Disclaimer</a></li>
          </ul>
        </div>
      </div>
      <div class="footer-bottom">
        <p>&copy; 2025 ISRIB Shop. All rights reserved. | Research chemicals for laboratory use only.</p>
      </div>
    </div>
  </footer>

  <!-- ============================================ -->
  <!-- ‚úÖ BTCPay Integration Scripts (BEFORE main.js!) -->
  <!-- ============================================ -->
  <script src="js/btcpay-config.js"></script>
  <script src="js/btcpay.js"></script>
  <script src="js/checkout-payment-selector.js"></script>

  <!-- App JS (after BTCPay modules) -->
  <script src="js/main.js?v=35"></script>

  <!-- ============================================ -->
  <!-- ‚úÖ ORDER ID GENERATION                       -->
  <!-- ============================================ -->
  <script>
(function() {
  // ============================================
  // ‚úÖ –§–£–ù–ö–¶–Ü–Ø –î–õ–Ø –û–¢–†–ò–ú–ê–ù–ù–Ø –ê–ë–û –ì–ï–ù–ï–†–ê–¶–Ü–á ORDER ID
  // ============================================
  function getOrCreateOrderId() {
    const SESSION_KEY = '_order_id';
    const TIMESTAMP_KEY = '_order_timestamp';
    const MAX_AGE = 30 * 60 * 1000; // 30 —Ö–≤–∏–ª–∏–Ω
    
    try {
      // 1. –°–ø—Ä–æ–±—É—î–º–æ –æ—Ç—Ä–∏–º–∞—Ç–∏ –∑ sessionStorage
      const stored = sessionStorage.getItem(SESSION_KEY);
      const timestamp = parseInt(sessionStorage.getItem(TIMESTAMP_KEY) || '0');
      
      if (stored && (Date.now() - timestamp) < MAX_AGE) {
        console.log('[CHECKOUT] ‚ôªÔ∏è Reusing existing Order ID:', stored);
        return stored;
      }
      
      // 2. –°–ø—Ä–æ–±—É—î–º–æ –æ—Ç—Ä–∏–º–∞—Ç–∏ –∑ _checkout_data
      const checkoutData = sessionStorage.getItem('_checkout_data');
      if (checkoutData) {
        try {
          const parsed = JSON.parse(checkoutData);
          if (parsed.order_id) {
            console.log('[CHECKOUT] üìã Found Order ID in checkout data:', parsed.order_id);
            sessionStorage.setItem(SESSION_KEY, parsed.order_id);
            sessionStorage.setItem(TIMESTAMP_KEY, Date.now().toString());
            return parsed.order_id;
          }
        } catch(e) {}
      }
      
      // 3. –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —î pending order –≤ localStorage
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith('pending_order_')) {
          try {
            const orderData = JSON.parse(localStorage.getItem(key) || '{}');
            if (orderData.email === 'pending@direct-buy' && orderData.order_id) {
              console.log('[CHECKOUT] üîÑ Found pending order from direct buy:', orderData.order_id);
              sessionStorage.setItem(SESSION_KEY, orderData.order_id);
              sessionStorage.setItem(TIMESTAMP_KEY, Date.now().toString());
              return orderData.order_id;
            }
          } catch(e) {}
        }
      }
      
    } catch(e) {
      console.warn('[CHECKOUT] ‚ö†Ô∏è Error checking existing Order ID:', e);
    }
    
    // 4. –Ø–∫—â–æ –Ω—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ - –≥–µ–Ω–µ—Ä—É—î–º–æ –Ω–æ–≤–∏–π
    const timestamp = Date.now();
    const random = Math.random().toString(36).substring(2, 9).toUpperCase();
    const orderId = `ORD-${timestamp}-${random}`;
    
    try {
      sessionStorage.setItem(SESSION_KEY, orderId);
      sessionStorage.setItem(TIMESTAMP_KEY, timestamp.toString());
      console.log('[CHECKOUT] ‚ú® Created new Order ID:', orderId);
    } catch(e) {
      console.warn('[CHECKOUT] ‚ö†Ô∏è Cannot save Order ID to sessionStorage');
    }
    
    return orderId;
  }
  
  // –ì–µ–Ω–µ—Ä—É—î–º–æ Order ID –û–î–†–ê–ó–£ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ checkout
  const orderId = getOrCreateOrderId();
  
  // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–ª—è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –≤ main.js
  window._generatedOrderId = orderId;
  
  console.log('[CHECKOUT] üÜî Active Order ID:', orderId);
  
  // ============================================
  // ‚úÖ –û–ù–û–í–õ–Æ–Ñ–ú–û PENDING ORDER –Ø–ö–©–û –ü–û–¢–†–Ü–ë–ù–û
  // ============================================
  try {
    const pendingKey = 'pending_order_' + orderId;
    const existingOrder = localStorage.getItem(pendingKey);
    
    if (existingOrder) {
      const orderData = JSON.parse(existingOrder);
      console.log('[CHECKOUT] üì¶ Found existing pending order:', orderData);
      
      if (orderData.email === 'pending@direct-buy') {
        orderData.checkout_opened_at = Date.now();
        localStorage.setItem(pendingKey, JSON.stringify(orderData));
        console.log('[CHECKOUT] üîÑ Updated pending order timestamp');
      }
    } else {
      console.log('[CHECKOUT] ‚ÑπÔ∏è No existing pending order found (will be created on submit)');
    }
  } catch(e) {
    console.error('[CHECKOUT] ‚ùå Error updating pending order:', e);
  }
})();
</script>

  <!-- ============================================ -->
  <!-- ‚úÖ BEGIN_CHECKOUT GA4 + REDDIT PIXEL EVENT   -->
  <!-- ============================================ -->
  <script>
(function fireBeginCheckout() {
  console.log('[CHECKOUT] üîß Initializing begin_checkout...');
  
  // Helper function –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥—É –∫—ñ–ª—å–∫–æ—Å—Ç—ñ
  function parseQtyToMg(s) {
    if (!s) return 0;
    const t = String(s).toLowerCase().trim();
    const n = parseFloat(t.replace(/[^0-9.]/g, '')) || 0;
    return t.includes('g') && !t.includes('mg') ? Math.round(n * 1000) : Math.round(n);
  }
  
  // –ß–µ–∫–∞—î–º–æ –ø–æ–∫–∏ GTM —Ç–∞ Reddit Pixel –∑–∞–≤–∞–Ω—Ç–∞–∂–∞—Ç—å—Å—è + DOM ready
  setTimeout(function() {
    try {
      const cart = JSON.parse(localStorage.getItem('isrib_cart') || '[]');
      
      if (cart.length === 0) {
        console.log('[CHECKOUT] ‚ö†Ô∏è begin_checkout skipped - empty cart');
        return;
      }
      
      // –ù–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—è –æ–¥–∏–Ω–∏—Ü—å
      const normalizedCart = cart.map(item => {
        let grams = Number(item.grams || 0);
        if (item.display) {
          const mgFromLabel = parseQtyToMg(item.display);
          if (mgFromLabel) grams = mgFromLabel;
        }
        return { ...item, grams };
      });
      
      // –†–æ–∑—Ä–∞—Ö–æ–≤—É—î–º–æ –∑–∞–≥–∞–ª—å–Ω—É –≤–∞—Ä—Ç—ñ—Å—Ç—å
      const cartValue = normalizedCart.reduce((sum, item) => {
        return sum + (Number(item.price || 0) * Number(item.count || 1));
      }, 0);
      
      // –û—Ç—Ä–∏–º—É—î–º–æ Order ID —Ç–∞ Transaction ID
      const orderId = window._generatedOrderId || 'unknown';
      const txnId = sessionStorage.getItem('_txn_id') || orderId;
      
      // –§–æ—Ä–º—É—î–º–æ items –¥–ª—è GA4
      const ga4Items = normalizedCart.map(item => ({
        item_id: item.sku || 'unknown',
        item_name: item.name || 'Unknown Product',
        item_variant: item.display || (item.grams >= 1000 ? (item.grams/1000)+'g' : item.grams+'mg'),
        item_category: 'Research Compounds',
        price: Number(item.price || 0),
        quantity: Number(item.count || 1)
      }));
      
      console.log('[CHECKOUT] üì§ Preparing begin_checkout event:', {
        orderId: orderId,
        txnId: txnId,
        value: cartValue,
        items: ga4Items.length,
        itemDetails: ga4Items
      });
      
      // ============================================
      // ‚úÖ GA4 EVENT
      // ============================================
      window.dataLayer = window.dataLayer || [];
      
      window.dataLayer.push({
        event: 'begin_checkout',
        ecommerce: {
          currency: 'USD',
          value: cartValue,
          items: ga4Items
        },
        transaction_id: txnId,
        order_id: orderId,
        event_category: 'ecommerce',
        event_label: 'Checkout Started'
      });
      
      console.log('[GA4] ‚úÖ begin_checkout pushed to dataLayer');
      
      // ============================================
      // ‚úÖ REDDIT PIXEL EVENT: AddToCart (Begin Checkout)
      // ============================================
      if (window.RedditPixel && typeof window.RedditPixel.trackBeginCheckout === 'function') {
        window.RedditPixel.trackBeginCheckout(orderId, cartValue);
        console.log('[Reddit Pixel] ‚úÖ Begin Checkout event sent');
      } else {
        // Fallback: —è–∫—â–æ RedditPixel —â–µ –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–≤—Å—è
        console.log('[Reddit Pixel] ‚è≥ Waiting for RedditPixel to load...');
        setTimeout(function() {
          if (window.RedditPixel && typeof window.RedditPixel.trackBeginCheckout === 'function') {
            window.RedditPixel.trackBeginCheckout(orderId, cartValue);
            console.log('[Reddit Pixel] ‚úÖ Begin Checkout event sent (delayed)');
          } else if (typeof rdt !== 'undefined') {
            // Direct fallback
            rdt('track', 'AddToCart', {
              'transactionId': orderId,
              'value': cartValue,
              'currency': 'USD'
            });
            console.log('[Reddit Pixel] ‚úÖ Begin Checkout event sent (direct rdt)');
          } else {
            console.warn('[Reddit Pixel] ‚ö†Ô∏è Reddit Pixel not available');
          }
        }, 500);
      }
      
      // –î–æ–¥–∞—Ç–∫–æ–≤–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–∏ GTM –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–≤—Å—è
      if (window.google_tag_manager && window.google_tag_manager['GTM-M2QCB45Q']) {
        console.log('[GA4] ‚úÖ GTM container confirmed loaded');
      } else {
        console.warn('[GA4] ‚ö†Ô∏è GTM container may not be loaded yet');
      }
      
    } catch(error) {
      console.error('[CHECKOUT] ‚ùå begin_checkout error:', error);
      console.error('[CHECKOUT] Error stack:', error.stack);
    }
    
  }, 800); // –î–∞—î–º–æ 800ms –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è GTM —Ç–∞ Reddit Pixel
  
})();
</script>

</body>
</html>
